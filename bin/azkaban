#!/bin/sh

bin=`dirname "$0"`
bin=`cd "$bin" > /dev/null; pwd`

. "$bin"/azkaban-env.sh

usage() {
  echo "Usage: azkaban COMMAND"
  echo "where COMMAND is one of:"
  echo "  executor             start or stop the executor server"
  echo "  web                  start or stop the web server"
  echo "  solo                 start or stop the solo server"
  echo "  admin                start or stop the admin server"
  echo "Most commands print help when invoked without parameters."
}

# If there are no args specified, show usage.
if [ $# = 0 ]; then
  usage
  exit 1
fi

# Get subcommand
COMMAND=$1

# Support help commands
case $COMMAND in
  --help|-help|-h|help)
    usage
    exit 0
    ;;
esac

SERVER_HOME=

case $COMMAND in
  executor)
    if [ -z "$AZKABAN_EXECUTOR_HOME" ]; then
      echo "AZKABAN_EXECUTOR_HOME is not set."
      exit 1
    fi
    SERVER_HOME=$AZKABAN_EXECUTOR_HOME
    ;;

  web)
    if [ -z "$AZKABAN_WEB_HOME" ]; then
      echo "AZKABAN_WEB_HOME is not set."
      exit 1
    fi
    SERVER_HOME=$AZKABAN_WEB_HOME
    ;;

  solo)
    if [ -z "$AZKABAN_SOLO_HOME" ]; then
      echo "AZKABAN_SOLO_HOME is not set."
      exit 1
    fi
    SERVER_HOME=$AZKABAN_SOLO_HOME
    ;;

  admin)
    if [ -z "$AZKABAN_ADMIN_HOME" ]; then
      echo "AZKABAN_ADMIN_HOME is not set."
      exit 1
    fi
    SERVER_HOME=$AZKABAN_ADMIN_HOME
    ;;

  *)
    usage
    exit 1
    ;;
esac

case $COMMAND in
  executor|web|solo|admin)
    if [ $# != 2 ]; then
      echo "Usage: azkaban $COMMAND start|stop|restart"
      exit 1
    fi

    STARTSTOP=$2
    case $STARTSTOP in
      start)
        cd $SERVER_HOME && bash ./bin/azkaban-$COMMAND-start.sh
        ;;
      stop)
        cd $SERVER_HOME && bash ./bin/azkaban-$COMMAND-shutdown.sh
        ;;
      restart)
        cd $SERVER_HOME && bash ./bin/azkaban-$COMMAND-shutdown.sh
        cd $SERVER_HOME && bash ./bin/azkaban-$COMMAND-start.sh
        ;;
      *)
        echo "Usage: azkaban $COMMAND start|stop|restart"
        exit 1
        ;;
    esac
  ;;
esac
