#!/usr/bin/env python

import os
import subprocess
import shutil
import sys

VIM_BUNDLES_DIR = os.getenv('HOME') + '/.vim/bundle'

VIM_BUNDLE_REPOS = [
  'https://github.com/vim-scripts/jade.vim.git',
  'https://github.com/pbrisbin/html-template-syntax.git',
  'https://github.com/davidzchen/Syntax-for-Fasta.git',
  'https://github.com/vim-scripts/Superior-Haskell-Interaction-Mode-SHIM.git',
  'https://github.com/tpope/vim-markdown.git',
  'https://github.com/rainux/vim-vala.git',
  'https://github.com/vim-scripts/VimClojure.git',
  'https://github.com/vim-scripts/Io-programming-language-syntax.git',
  'https://github.com/juvenn/mustache.vim.git',
  'https://github.com/jvoorhis/coq.vim.git',
  'https://github.com/jnwhiteh/vim-golang.git',
  'https://github.com/timcharper/textile.vim.git',
  'https://github.com/ksauzz/thrift.vim.git',
  'https://github.com/uarun/vim-protobuf.git',
  'https://github.com/davidzchen/avro-vim.git',
  'https://github.com/davidzchen/pig.vim.git',
  'https://github.com/davidzchen/hive.vim.git',
  'https://github.com/davidzchen/rc.vim.git',
  'https://github.com/davidzchen/jproperties.vim.git',
  'https://github.com/lepture/vim-velocity.git',
  'https://github.com/jimmyhchan/dustjs.vim.git',
  'https://github.com/groenewege/vim-less.git',
  'https://github.com/derekwyatt/vim-sbt.git',
  'https://github.com/gre/play2vim.git',
  'https://github.com/othree/html5.vim.git',
  'https://github.com/derekwyatt/vim-scala.git',
  'https://github.com/kchmck/vim-coffee-script.git',
  'https://github.com/sellerie/vim-gradle.git',
  'https://github.com/pantsbuild/vim-pants.git',
  'https://github.com/wting/rust.vim.git',
  'https://github.com/b4winckler/vim-objc.git',
  'https://github.com/tpope/vim-haml.git',
  'https://github.com/blinks/vim-antlr.git',
  'https://github.com/cespare/vim-toml.git',

  # Color schemes
  'https://github.com/altercation/vim-colors-solarized.git',
  'https://github.com/chriskempson/base16-vim.git',

  # Misc
  'https://github.com/metalelf0/vimt0d0.git',

  # Tools
  'https://github.com/tpope/vim-dispatch.git',
  'https://github.com/tpope/vim-fugitive.git',
  'https://github.com/adinapoli/vim-markmultiple.git',
  'https://github.com/davidzchen/snipmate.vim.git',
  'https://github.com/sjl/gundo.vim.git',
  'https://github.com/ntpeters/vim-better-whitespace.git',
  'https://github.com/nathanaelkane/vim-indent-guides.git',
  'https://github.com/edkolev/tmuxline.vim.git',
  'https://github.com/bling/vim-airline.git',
  'https://github.com/dag/vim-fish.git',
  'https://github.com/kien/ctrlp.vim',
  'https://github.com/edkolev/promptline.vim.git',
  'https://github.com/scrooloose/nerdtree.git',

  # Commenting out syntastic until I figure out how to make Java work.
  'https://github.com/scrooloose/syntastic.git',

  # On OS X, Exuberant CTags must be installed:
  # brew install ctags-exuberant
  'https://github.com/majutsushi/tagbar.git',
  'https://github.com/airblade/vim-gitgutter.git',
]

class Print:
  UPDATE = '\033[94m'
  INSTALL = '\033[92m'
  REMOVE = '\033[93m'
  ENDC = '\033[0m'

  INDICATOR = '==> '

  @staticmethod
  def install(message):
    print Print.INSTALL + Print.INDICATOR + Print.ENDC + message

  @staticmethod
  def remove(message):
    print Print.REMOVE + Print.INDICATOR + Print.ENDC + message

  @staticmethod
  def update(message):
    print Print.UPDATE + Print.INDICATOR + Print.ENDC + message

def _get_bundle_name(url):
  parts = url.split('/')
  bundle = parts[-1]
  if bundle.endswith('.git'):
    bundle = bundle[:-4]
  return bundle

def _create_bundle_repo_map(repos):
  bundle_repo_map = {}
  for repo in repos:
    bundle_repo_map[_get_bundle_name(repo)] = repo
  return bundle_repo_map

def install_bundles(bundles_dir, bundles, bundle_repo_map):
  for bundle in bundles:
    Print.install("Installing bundle: %s" % bundle_repo_map[bundle])
    repo = bundle_repo_map[bundle]
    proc = subprocess.Popen(['git', 'clone', repo], cwd = bundles_dir)
    proc.wait()

def remove_bundles(bundles_dir, bundles):
  for bundle in bundles:
    Print.remove("Removing bundle: %s" % bundle)
    shutil.rmtree(os.path.join(bundles_dir, bundle))

def update_bundles(bundles_dir, bundles):
  for bundle in bundles:
    Print.update("Updating bundle: %s" % bundle)
    bundle_dir = os.path.join(bundles_dir, bundle)
    proc = subprocess.Popen(['git', 'pull'], cwd = bundle_dir)
    proc.wait()

def setup_vim_bundles(bundles_dir, repos):
  bundle_repo_map = _create_bundle_repo_map(repos)

  new_bundles = set(bundle_repo_map.keys())
  installed_bundles = set([ f for f
    in os.listdir(bundles_dir)
    if os.path.isdir(os.path.join(bundles_dir, f))
  ])

  common_bundles = new_bundles & installed_bundles
  bundles_to_install = new_bundles - common_bundles
  bundles_to_remove = installed_bundles - common_bundles

  install_bundles(bundles_dir, bundles_to_install, bundle_repo_map)
  remove_bundles(bundles_dir, bundles_to_remove)
  update_bundles(bundles_dir, common_bundles)

def main():
  if not os.path.isdir(VIM_BUNDLES_DIR):
    print "%s is not a directory." % VIM_BUNDLES_DIR
    sys.exit(os.EX_DATAERR)

  if not os.path.exists(VIM_BUNDLES_DIR):
    try:
      os.makedirs(VIM_BUNDLES_DIR)
    except IOError as err:
      print("Error creating bundle directory %s: %s"
          % (VIM_BUNDLES_DIR, str(err)))
      sys.exit(os.EX_IOERR)

  try:
    setup_vim_bundles(VIM_BUNDLES_DIR, VIM_BUNDLE_REPOS)
  except IOError as err:
    print "Error setting up bundles: %s" % str(err)
    sys.exit(os.EX_IOERR)

if __name__ == '__main__':
  main()
